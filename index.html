<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Strength & Scripture">
    <meta name="theme-color" content="#0A0E27">
    <title>Strength & Scripture Tracker</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="description" content="Strength & Scripture — a personal tracker for workouts and Bible reading.">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4D00;
            --secondary: #00D9FF;
            --dark: #0A0E27;
            --darker: #050812;
            --card: #151B3D;
            --text: #E8EEFF;
            --text-dim: #8B93B8;
            --success: #00FF88;
            --warning: #FFB800;
            --grid: rgba(0, 217, 255, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Barlow', sans-serif;
            background: var(--darker);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, var(--grid) 0px, transparent 1px, transparent 40px, var(--grid) 41px),
                repeating-linear-gradient(90deg, var(--grid) 0px, transparent 1px, transparent 40px, var(--grid) 41px),
                radial-gradient(ellipse at 20% 30%, rgba(255, 77, 0, 0.08), transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(0, 217, 255, 0.08), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4.5rem;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            background: var(--card);
            padding: 1.5rem 2rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.1);
            flex: 1;
            min-width: 200px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 217, 255, 0.3);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 0.05em;
            line-height: 1;
        }

        .stat-value.success {
            color: var(--success);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.8s ease-out 0.3s both;
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.05em;
            padding: 1rem 1.5rem;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--text);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .view.active {
            display: block;
        }

        .workout-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .workout-type-btn {
            flex: 1;
            min-width: 200px;
            padding: 2rem;
            background: var(--card);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .workout-type-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 77, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .workout-type-btn:hover::before {
            left: 100%;
        }

        .workout-type-btn:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(255, 77, 0, 0.2);
        }

        .workout-type-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 77, 0, 0.1), rgba(0, 217, 255, 0.1));
        }

        .exercise-list {
            display: grid;
            gap: 1rem;
        }

        .exercise-item {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .exercise-item.completed {
            opacity: 0.6;
            max-height: 80px;
            overflow: hidden;
            padding: 1rem 1.5rem;
        }

        .exercise-item.completed .exercise-inputs,
        .exercise-item.completed .rest-badge,
        .exercise-item.completed .suggestion {
            display: none;
        }

        .exercise-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .exercise-checkbox:checked {
            background: var(--success);
            border-color: var(--success);
        }

        .exercise-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--dark);
            font-size: 16px;
            font-weight: bold;
        }

        .exercise-item:hover {
            border-color: rgba(0, 217, 255, 0.2);
            transform: translateX(4px);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.05em;
            color: var(--text);
        }

        .rest-badge {
            background: rgba(0, 217, 255, 0.1);
            color: var(--secondary);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .exercise-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .input-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        input[type="number"] {
            background: var(--darker);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 0.75rem;
            color: var(--text);
            font-family: 'Barlow', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .suggestion {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            padding: 0.75rem;
            font-size: 0.85rem;
            color: var(--success);
            margin-top: 0.5rem;
            display: none;
        }

        .suggestion.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .complete-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 2rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .complete-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .complete-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 77, 0, 0.4);
        }

        .mode-toggle {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 0.5rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Barlow', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .mode-toggle:hover {
            border-color: rgba(0, 217, 255, 0.3);
            color: var(--text);
        }

        .mode-toggle.active {
            background: linear-gradient(135deg, rgba(255, 77, 0, 0.2), rgba(0, 217, 255, 0.2));
            border-color: var(--secondary);
            color: var(--text);
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            transition: all 0.3s;
            padding: 0.5rem;
        }

        .calendar-day .day-number {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .calendar-day .day-name {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .calendar-day.today {
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.2);
        }

        .activity-pill {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .workout-pill {
            background: rgba(255, 77, 0, 0.15);
            color: var(--primary);
            border: 1px solid rgba(255, 77, 0, 0.3);
        }

        .reading-pill {
            background: rgba(0, 217, 255, 0.15);
            color: var(--secondary);
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .chart-container {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .chart-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.05em;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .chart {
            height: 300px;
            position: relative;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 2.5rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .stats-bar {
                gap: 0.75rem;
            }

            .stat-card {
                min-width: unset;
                padding: 1rem 1.25rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .workout-selector {
                flex-direction: column;
            }

            .workout-type-btn {
                min-width: unset;
                padding: 1.5rem;
                font-size: 1.5rem;
            }

            .exercise-inputs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 0.75rem;
            }

            .input-group {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 0.5rem;
                align-items: center;
            }

            .input-group:nth-child(1),
            .input-group:nth-child(2) {
                /* Sets and Reps on first row */
            }

            .input-group:nth-child(3) {
                /* Weight spans full width on second row */
                grid-column: 1 / -1;
            }

            .input-label {
                font-size: 0.8rem;
                margin: 0;
                white-space: nowrap;
            }

            input[type="number"] {
                font-size: 1rem;
                padding: 0.75rem;
                width: 100%;
                /* Prevent zoom on iOS */
                touch-action: manipulation;
            }

            .tabs {
                gap: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                font-size: 1.2rem;
                padding: 0.75rem 1rem;
                white-space: nowrap;
            }

            .calendar {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .calendar-day {
                aspect-ratio: unset;
                min-height: unset;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }

            .calendar-day .day-name {
                font-size: 0.75rem;
                text-align: left;
            }

            .calendar-day .day-number {
                font-size: 1.3rem;
                margin: 0;
                text-align: left;
            }

            .mode-toggle {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            input[type="number"] {
                font-size: 1rem;
                padding: 0.75rem;
                /* Prevent zoom on iOS */
                touch-action: manipulation;
            }

            .complete-btn {
                padding: 1.25rem 2rem;
                font-size: 1.3rem;
                /* Better touch target */
                min-height: 56px;
            }

            .exercise-item {
                padding: 1.25rem;
            }

            .exercise-name {
                font-size: 1.3rem;
            }

            .chart-container {
                padding: 1.5rem;
            }

            .chart-title {
                font-size: 1.5rem;
            }

            /* Make today's reading more readable on mobile */
            #todayReading {
                font-size: 1rem;
                line-height: 1.6;
            }

            /* Better touch targets for workout/reading buttons */
            .workout-type-btn,
            .complete-btn,
            #completeReading {
                -webkit-tap-highlight-color: rgba(255, 77, 0, 0.2);
            }
        }

        /* Prevent text size adjustment on orientation change */
        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* Better touch scrolling */
        .view {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>STRENGTH & SCRIPTURE</h1>
            <div class="subtitle">Build Body & Spirit. Track Progress. Grow Strong.</div>
        </header>

        <div style="margin-bottom: 3rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="var(--primary)">
                    <path d="M20.57 14.86L22 13.43L20.57 12L17 15.57L8.43 7L12 3.43L10.57 2L9.14 3.43L7.71 2L5.57 4.14L4.14 2.71L2.71 4.14L4.14 5.57L2 7.71L3.43 9.14L2 10.57L3.43 12L7 8.43L15.57 17L12 20.57L13.43 22L14.86 20.57L16.29 22L18.43 19.86L19.86 21.29L21.29 19.86L19.86 18.43L22 16.29L20.57 14.86Z" />
                </svg>
                <div class="stats-bar" style="flex: 1; margin: 0;">
                    <div class="stat-card" style="border-left-color: var(--primary);">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value success" id="weekWorkouts">0/3</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--primary);">
                        <div class="stat-label">Total Workouts</div>
                        <div class="stat-value" id="totalWorkouts">0</div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <svg width="48" height="48" viewBox="0 -960 960 960" fill="var(--secondary)">
                    <path d="M440-278v-394q-41-24-87-36t-93-12q-36 0-71.5 7T120-692v396q35-12 69.5-18t70.5-6q47 0 91.5 10.5T440-278Zm40 118q-48-38-104-59t-116-21q-42 0-82.5 11T100-198q-21 11-40.5-1T40-234v-482q0-11 5.5-21T62-752q46-24 96-36t102-12q74 0 126 17t112 52q11 6 16.5 14t5.5 21v418q44-21 88.5-31.5T700-320q36 0 70.5 6t69.5 18v-481q15 5 29.5 11t28.5 14q11 5 16.5 15t5.5 21v482q0 23-19.5 35t-40.5 1q-37-20-77.5-31T700-240q-60 0-116 21t-104 59Zm140-240v-440l120-40v440l-120 40Zm-340-99Z"/>
                </svg>
                <div class="stats-bar" style="flex: 1; margin: 0;">
                    <div class="stat-card" style="border-left-color: var(--secondary);">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value success" id="weekReadings">0/5</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--secondary);">
                        <div class="stat-label">Overall Progress</div>
                        <div class="stat-value" id="bibleProgress">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-view="workout">Workout</button>
            <button class="tab" data-view="bible">Bible</button>
            <button class="tab" data-view="calendar">Calendar</button>
            <button class="tab" data-view="progress">Progress</button>
        </div>

        <div class="view" id="bible">
            <div style="display: grid; gap: 2rem;">
                <!-- Today's Reading -->
                <div class="chart-container">
                    <div class="chart-title">Today's Reading Assignment</div>
                    <div id="todayReading" style="font-size: 1.1rem; line-height: 1.8; color: var(--text);">
                        <div class="no-data">Loading reading plan...</div>
                    </div>
                    <button class="complete-btn" id="completeReading" style="margin-top: 1.5rem; display: none;">Mark Reading Complete</button>
                </div>

                <!-- Reading Progress -->
                <div class="chart-container">
                    <div class="chart-title">Reading Progress</div>
                    <div id="readingProgress">
                        <div style="display: grid; gap: 1rem;">
                            <div class="progress-stream">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: var(--text);">Old Testament (Mon/Wed/Fri)</span>
                                    <span style="color: var(--text-dim); font-size: 0.9rem;" id="mwfProgress">0%</span>
                                </div>
                                <div style="background: var(--darker); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="mwfBar" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.5s;"></div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-dim);" id="mwfCurrent">Not started</div>
                            </div>
                            
                            <div class="progress-stream">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: var(--text);">New Testament (Tue/Thu)</span>
                                    <span style="color: var(--text-dim); font-size: 0.9rem;" id="tthProgress">0%</span>
                                </div>
                                <div style="background: var(--darker); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="tthBar" style="height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.5s;"></div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-dim);" id="tthCurrent">Not started</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view active" id="workout">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="color: var(--text-dim); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">Mode:</span>
                    <button class="mode-toggle active" data-mode="gym">Gym</button>
                    <button class="mode-toggle" data-mode="travel">Travel/Home</button>
                </div>
            </div>
            <div class="workout-selector">
                <button class="workout-type-btn" data-type="push">Push</button>
                <button class="workout-type-btn" data-type="pull">Pull</button>
                <button class="workout-type-btn" data-type="legs">Legs</button>
            </div>
            <div id="exerciseList" class="exercise-list"></div>
            <button class="complete-btn" id="completeWorkout" style="display: none;">Complete Workout</button>
        </div>

        <div class="view" id="calendar">
            <div class="calendar" id="calendarView"></div>
        </div>

        <div class="view" id="progress">
            <div class="chart-container">
                <div class="chart-title">Exercise Progress</div>
                <select id="exerciseSelect" style="background: var(--darker); color: var(--text); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 4px; font-size: 1rem; margin-bottom: 1.5rem; width: 100%;">
                    <option>Select an exercise to view progress</option>
                </select>
                <div class="chart" id="progressChart">
                    <div class="no-data">Complete workouts to see your progress here</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        
  // ---- Storage adapter (localStorage fallback) ----
  // Your app calls window.storage.get/set. GitHub Pages doesn't provide that by default,
  // so we create a compatible version backed by localStorage.
  if (!window.storage) {
    window.storage = {
      async get(key) {
        const value = localStorage.getItem(key);
        // Your existing code expects an object like { value: "..." } or null
        return value === null ? null : { value };
      },
      async set(key, value) {
        localStorage.setItem(key, value);
        return true;
      },
      async remove(key) {
        localStorage.removeItem(key);
        return true;
      }
    };
  }
  // -----------------------------------------------
// Complete Bible Reading Plan Data - 1 Year, 5 Days/Week
        const bibleReadingPlan = {
            // Mon/Wed/Fri stream - 156 days total, 6-7 chapters/day
            // Old Testament Chronological → Matthew → Acts → Revelation
            mwf: [
                // GENESIS 1-11 (Creation to Babel)
                { book: 'Genesis', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Genesis', chapters: [7, 8, 9, 10, 11] },
                
                // JOB (placed with patriarchal period)
                { book: 'Job', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Job', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Job', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Job', chapters: [21, 22, 23, 24, 25, 26] },
                { book: 'Job', chapters: [27, 28, 29, 30, 31, 32] },
                { book: 'Job', chapters: [33, 34, 35, 36, 37, 38, 39] },
                { book: 'Job', chapters: [40, 41, 42] },
                
                // GENESIS 12-50 (Patriarchs)
                { book: 'Genesis', chapters: [12, 13, 14, 15, 16, 17] },
                { book: 'Genesis', chapters: [18, 19, 20, 21, 22, 23, 24] },
                { book: 'Genesis', chapters: [25, 26, 27, 28, 29, 30] },
                { book: 'Genesis', chapters: [31, 32, 33, 34, 35, 36] },
                { book: 'Genesis', chapters: [37, 38, 39, 40, 41, 42] },
                { book: 'Genesis', chapters: [43, 44, 45, 46, 47, 48] },
                { book: 'Genesis', chapters: [49, 50] },
                
                // EXODUS
                { book: 'Exodus', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Exodus', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Exodus', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Exodus', chapters: [21, 22, 23, 24, 25, 26] },
                { book: 'Exodus', chapters: [27, 28, 29, 30, 31, 32] },
                { book: 'Exodus', chapters: [33, 34, 35, 36, 37, 38] },
                { book: 'Exodus', chapters: [39, 40] },
                
                // LEVITICUS
                { book: 'Leviticus', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Leviticus', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Leviticus', chapters: [14, 15, 16, 17, 18, 19] },
                { book: 'Leviticus', chapters: [20, 21, 22, 23, 24, 25] },
                { book: 'Leviticus', chapters: [26, 27] },
                
                // NUMBERS
                { book: 'Numbers', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Numbers', chapters: [7, 8, 9, 10, 11, 12] },
                { book: 'Numbers', chapters: [13, 14, 15, 16, 17, 18, 19] },
                { book: 'Numbers', chapters: [20, 21, 22, 23, 24, 25] },
                { book: 'Numbers', chapters: [26, 27, 28, 29, 30, 31] },
                { book: 'Numbers', chapters: [32, 33, 34, 35, 36] },
                
                // DEUTERONOMY
                { book: 'Deuteronomy', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Deuteronomy', chapters: [7, 8, 9, 10, 11, 12, 13] },
                { book: 'Deuteronomy', chapters: [14, 15, 16, 17, 18, 19] },
                { book: 'Deuteronomy', chapters: [20, 21, 22, 23, 24, 25, 26] },
                { book: 'Deuteronomy', chapters: [27, 28, 29, 30, 31, 32] },
                { book: 'Deuteronomy', chapters: [33, 34] },
                
                // JOSHUA
                { book: 'Joshua', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Joshua', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Joshua', chapters: [14, 15, 16, 17, 18, 19] },
                { book: 'Joshua', chapters: [20, 21, 22, 23, 24] },
                
                // JUDGES & RUTH
                { book: 'Judges', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Judges', chapters: [7, 8, 9, 10, 11, 12] },
                { book: 'Judges', chapters: [13, 14, 15, 16, 17, 18] },
                { book: 'Judges', chapters: [19, 20, 21] },
                { book: 'Ruth', chapters: [1, 2, 3, 4] },
                
                // 1 SAMUEL
                { book: '1 Samuel', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: '1 Samuel', chapters: [8, 9, 10, 11, 12, 13] },
                { book: '1 Samuel', chapters: [14, 15, 16, 17, 18, 19] },
                { book: '1 Samuel', chapters: [20, 21, 22, 23, 24, 25] },
                { book: '1 Samuel', chapters: [26, 27, 28, 29, 30, 31] },
                
                // 2 SAMUEL & PSALMS (David's reign)
                { book: '2 Samuel', chapters: [1, 2, 3, 4, 5, 6] },
                { book: '2 Samuel', chapters: [7, 8, 9, 10, 11, 12] },
                { book: 'Psalm', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Psalm', chapters: [8, 9, 10, 11, 12, 13, 14] },
                { book: '2 Samuel', chapters: [13, 14, 15, 16, 17, 18] },
                { book: '2 Samuel', chapters: [19, 20, 21, 22, 23, 24] },
                { book: 'Psalm', chapters: [15, 16, 17, 18, 19, 20, 21] },
                { book: 'Psalm', chapters: [22, 23, 24, 25, 26, 27] },
                
                // 1 KINGS 1-11 & MORE PSALMS (Solomon)
                { book: '1 Kings', chapters: [1, 2, 3, 4, 5, 6] },
                { book: '1 Kings', chapters: [7, 8, 9, 10, 11] },
                { book: 'Psalm', chapters: [28, 29, 30, 31, 32, 33, 34] },
                { book: 'Psalm', chapters: [35, 36, 37, 38, 39, 40] },
                { book: 'Proverbs', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Proverbs', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Proverbs', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Proverbs', chapters: [21, 22, 23, 24, 25, 26] },
                { book: 'Proverbs', chapters: [27, 28, 29, 30, 31] },
                { book: 'Ecclesiastes', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Ecclesiastes', chapters: [7, 8, 9, 10, 11, 12] },
                { book: 'Song of Solomon', chapters: [1, 2, 3, 4, 5, 6, 7, 8] },
                
                // DIVIDED KINGDOM - 1 KINGS 12-22
                { book: '1 Kings', chapters: [12, 13, 14, 15, 16, 17] },
                { book: '1 Kings', chapters: [18, 19, 20, 21, 22] },
                
                // 2 KINGS & PROPHETS
                { book: '2 Kings', chapters: [1, 2, 3, 4, 5, 6] },
                { book: '2 Kings', chapters: [7, 8, 9, 10, 11, 12, 13] },
                { book: 'Jonah', chapters: [1, 2, 3, 4] },
                { book: 'Amos', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Amos', chapters: [8, 9] },
                { book: 'Hosea', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Hosea', chapters: [8, 9, 10, 11, 12, 13, 14] },
                { book: '2 Kings', chapters: [14, 15, 16, 17, 18, 19] },
                { book: 'Isaiah', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Isaiah', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Isaiah', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Isaiah', chapters: [21, 22, 23, 24, 25, 26] },
                { book: 'Isaiah', chapters: [27, 28, 29, 30, 31, 32, 33] },
                { book: 'Isaiah', chapters: [34, 35, 36, 37, 38, 39] },
                { book: 'Isaiah', chapters: [40, 41, 42, 43, 44, 45] },
                { book: 'Isaiah', chapters: [46, 47, 48, 49, 50, 51, 52] },
                { book: 'Isaiah', chapters: [53, 54, 55, 56, 57, 58] },
                { book: 'Isaiah', chapters: [59, 60, 61, 62, 63, 64, 65, 66] },
                { book: 'Micah', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: '2 Kings', chapters: [20, 21, 22, 23, 24, 25] },
                { book: 'Nahum', chapters: [1, 2, 3] },
                { book: 'Zephaniah', chapters: [1, 2, 3] },
                { book: 'Habakkuk', chapters: [1, 2, 3] },
                { book: 'Jeremiah', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Jeremiah', chapters: [7, 8, 9, 10, 11, 12, 13] },
                { book: 'Jeremiah', chapters: [14, 15, 16, 17, 18, 19] },
                { book: 'Jeremiah', chapters: [20, 21, 22, 23, 24, 25, 26] },
                { book: 'Jeremiah', chapters: [27, 28, 29, 30, 31, 32] },
                { book: 'Jeremiah', chapters: [33, 34, 35, 36, 37, 38] },
                { book: 'Jeremiah', chapters: [39, 40, 41, 42, 43, 44, 45] },
                { book: 'Jeremiah', chapters: [46, 47, 48, 49, 50, 51] },
                { book: 'Jeremiah', chapters: [52] },
                { book: 'Lamentations', chapters: [1, 2, 3, 4, 5] },
                { book: 'Obadiah', chapters: [1] },
                { book: 'Ezekiel', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Ezekiel', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Ezekiel', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Ezekiel', chapters: [21, 22, 23, 24, 25, 26] },
                { book: 'Ezekiel', chapters: [27, 28, 29, 30, 31, 32, 33] },
                { book: 'Ezekiel', chapters: [34, 35, 36, 37, 38, 39] },
                { book: 'Ezekiel', chapters: [40, 41, 42, 43, 44, 45] },
                { book: 'Ezekiel', chapters: [46, 47, 48] },
                { book: 'Daniel', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Daniel', chapters: [7, 8, 9, 10, 11, 12] },
                
                // POST-EXILE
                { book: 'Ezra', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Ezra', chapters: [7, 8, 9, 10] },
                { book: 'Haggai', chapters: [1, 2] },
                { book: 'Zechariah', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Zechariah', chapters: [8, 9, 10, 11, 12, 13, 14] },
                { book: 'Esther', chapters: [1, 2, 3, 4, 5, 6] },
                { book: 'Esther', chapters: [7, 8, 9, 10] },
                { book: 'Nehemiah', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Nehemiah', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Malachi', chapters: [1, 2, 3, 4] },
                
                // REMAINING PSALMS
                { book: 'Psalm', chapters: [41, 42, 43, 44, 45, 46, 47] },
                { book: 'Psalm', chapters: [48, 49, 50, 51, 52, 53, 54] },
                { book: 'Psalm', chapters: [55, 56, 57, 58, 59, 60, 61] },
                { book: 'Psalm', chapters: [62, 63, 64, 65, 66, 67] },
                { book: 'Psalm', chapters: [68, 69, 70, 71, 72, 73, 74] },
                { book: 'Psalm', chapters: [75, 76, 77, 78, 79, 80] },
                { book: 'Psalm', chapters: [81, 82, 83, 84, 85, 86, 87] },
                { book: 'Psalm', chapters: [88, 89, 90, 91, 92, 93] },
                { book: 'Psalm', chapters: [94, 95, 96, 97, 98, 99, 100] },
                { book: 'Psalm', chapters: [101, 102, 103, 104, 105, 106] },
                { book: 'Psalm', chapters: [107, 108, 109, 110, 111, 112, 113] },
                { book: 'Psalm', chapters: [114, 115, 116, 117, 118, 119] }, // 119 is long
                { book: 'Psalm', chapters: [120, 121, 122, 123, 124, 125, 126] },
                { book: 'Psalm', chapters: [127, 128, 129, 130, 131, 132, 133] },
                { book: 'Psalm', chapters: [134, 135, 136, 137, 138, 139, 140] },
                { book: 'Psalm', chapters: [141, 142, 143, 144, 145, 146, 147] },
                { book: 'Psalm', chapters: [148, 149, 150] },
                
                // 1 & 2 CHRONICLES (recap)
                { book: '1 Chronicles', chapters: [1, 2, 3, 4, 5, 6] },
                { book: '1 Chronicles', chapters: [7, 8, 9, 10, 11, 12, 13] },
                { book: '1 Chronicles', chapters: [14, 15, 16, 17, 18, 19] },
                { book: '1 Chronicles', chapters: [20, 21, 22, 23, 24, 25, 26] },
                { book: '1 Chronicles', chapters: [27, 28, 29] },
                { book: '2 Chronicles', chapters: [1, 2, 3, 4, 5, 6] },
                { book: '2 Chronicles', chapters: [7, 8, 9, 10, 11, 12, 13] },
                { book: '2 Chronicles', chapters: [14, 15, 16, 17, 18, 19] },
                { book: '2 Chronicles', chapters: [20, 21, 22, 23, 24, 25, 26] },
                { book: '2 Chronicles', chapters: [27, 28, 29, 30, 31, 32] },
                { book: '2 Chronicles', chapters: [33, 34, 35, 36] },
                { book: 'Joel', chapters: [1, 2, 3] },
                
                // MATTHEW (28 chapters across 4 days)
                { book: 'Matthew', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Matthew', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Matthew', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Matthew', chapters: [21, 22, 23, 24, 25, 26, 27, 28] },
                
                // ACTS (28 chapters across 4 days)
                { book: 'Acts', chapters: [1, 2, 3, 4, 5, 6, 7] },
                { book: 'Acts', chapters: [8, 9, 10, 11, 12, 13] },
                { book: 'Acts', chapters: [14, 15, 16, 17, 18, 19, 20] },
                { book: 'Acts', chapters: [21, 22, 23, 24, 25, 26, 27, 28] },
                
                // REVELATION (22 chapters across 3 days)
                { book: 'Revelation', chapters: [1, 2, 3, 4, 5, 6, 7, 8] },
                { book: 'Revelation', chapters: [9, 10, 11, 12, 13, 14] },
                { book: 'Revelation', chapters: [15, 16, 17, 18, 19, 20, 21, 22] }
            ],
            
            // Tue/Thu stream - 104 days total
            // Each day: 1 Epistle chapter (87 total) + Gospel/Acts/Rev
            // Year 1: Matthew (28) + Mark (16) + Acts (28) + Revelation (22) = 94 chapters
            // Year 2: Luke (24) + John (21) + Acts (28) + Revelation (22) = 95 chapters
            // Epistles spread across ~87 days, Gospel stream across all 104 days
            tth: [
                // Day 1-6: Galatians + Matthew 1-6
                { epistle: 'Galatians', epistleChapter: 1, gospel: 'Matthew', gospelChapter: 1 },
                { epistle: 'Galatians', epistleChapter: 2, gospel: 'Matthew', gospelChapter: 2 },
                { epistle: 'Galatians', epistleChapter: 3, gospel: 'Matthew', gospelChapter: 3 },
                { epistle: 'Galatians', epistleChapter: 4, gospel: 'Matthew', gospelChapter: 4 },
                { epistle: 'Galatians', epistleChapter: 5, gospel: 'Matthew', gospelChapter: 5 },
                { epistle: 'Galatians', epistleChapter: 6, gospel: 'Matthew', gospelChapter: 6 },
                
                // Day 7-11: James + Matthew 7-11
                { epistle: 'James', epistleChapter: 1, gospel: 'Matthew', gospelChapter: 7 },
                { epistle: 'James', epistleChapter: 2, gospel: 'Matthew', gospelChapter: 8 },
                { epistle: 'James', epistleChapter: 3, gospel: 'Matthew', gospelChapter: 9 },
                { epistle: 'James', epistleChapter: 4, gospel: 'Matthew', gospelChapter: 10 },
                { epistle: 'James', epistleChapter: 5, gospel: 'Matthew', gospelChapter: 11 },
                
                // Day 12-16: 1 Thess + Matthew 12-16
                { epistle: '1 Thessalonians', epistleChapter: 1, gospel: 'Matthew', gospelChapter: 12 },
                { epistle: '1 Thessalonians', epistleChapter: 2, gospel: 'Matthew', gospelChapter: 13 },
                { epistle: '1 Thessalonians', epistleChapter: 3, gospel: 'Matthew', gospelChapter: 14 },
                { epistle: '1 Thessalonians', epistleChapter: 4, gospel: 'Matthew', gospelChapter: 15 },
                { epistle: '1 Thessalonians', epistleChapter: 5, gospel: 'Matthew', gospelChapter: 16 },
                
                // Day 17-19: 2 Thess + Matthew 17-19
                { epistle: '2 Thessalonians', epistleChapter: 1, gospel: 'Matthew', gospelChapter: 17 },
                { epistle: '2 Thessalonians', epistleChapter: 2, gospel: 'Matthew', gospelChapter: 18 },
                { epistle: '2 Thessalonians', epistleChapter: 3, gospel: 'Matthew', gospelChapter: 19 },
                
                // Day 20-28: 1 Cor 1-9 + Matthew 20-28
                { epistle: '1 Corinthians', epistleChapter: 1, gospel: 'Matthew', gospelChapter: 20 },
                { epistle: '1 Corinthians', epistleChapter: 2, gospel: 'Matthew', gospelChapter: 21 },
                { epistle: '1 Corinthians', epistleChapter: 3, gospel: 'Matthew', gospelChapter: 22 },
                { epistle: '1 Corinthians', epistleChapter: 4, gospel: 'Matthew', gospelChapter: 23 },
                { epistle: '1 Corinthians', epistleChapter: 5, gospel: 'Matthew', gospelChapter: 24 },
                { epistle: '1 Corinthians', epistleChapter: 6, gospel: 'Matthew', gospelChapter: 25 },
                { epistle: '1 Corinthians', epistleChapter: 7, gospel: 'Matthew', gospelChapter: 26 },
                { epistle: '1 Corinthians', epistleChapter: 8, gospel: 'Matthew', gospelChapter: 27 },
                { epistle: '1 Corinthians', epistleChapter: 9, gospel: 'Matthew', gospelChapter: 28 },
                
                // Day 29-44: 1 Cor 10-16 + 2 Cor 1-8 + Mark 1-16
                { epistle: '1 Corinthians', epistleChapter: 10, gospel: 'Mark', gospelChapter: 1 },
                { epistle: '1 Corinthians', epistleChapter: 11, gospel: 'Mark', gospelChapter: 2 },
                { epistle: '1 Corinthians', epistleChapter: 12, gospel: 'Mark', gospelChapter: 3 },
                { epistle: '1 Corinthians', epistleChapter: 13, gospel: 'Mark', gospelChapter: 4 },
                { epistle: '1 Corinthians', epistleChapter: 14, gospel: 'Mark', gospelChapter: 5 },
                { epistle: '1 Corinthians', epistleChapter: 15, gospel: 'Mark', gospelChapter: 6 },
                { epistle: '1 Corinthians', epistleChapter: 16, gospel: 'Mark', gospelChapter: 7 },
                { epistle: '2 Corinthians', epistleChapter: 1, gospel: 'Mark', gospelChapter: 8 },
                { epistle: '2 Corinthians', epistleChapter: 2, gospel: 'Mark', gospelChapter: 9 },
                { epistle: '2 Corinthians', epistleChapter: 3, gospel: 'Mark', gospelChapter: 10 },
                { epistle: '2 Corinthians', epistleChapter: 4, gospel: 'Mark', gospelChapter: 11 },
                { epistle: '2 Corinthians', epistleChapter: 5, gospel: 'Mark', gospelChapter: 12 },
                { epistle: '2 Corinthians', epistleChapter: 6, gospel: 'Mark', gospelChapter: 13 },
                { epistle: '2 Corinthians', epistleChapter: 7, gospel: 'Mark', gospelChapter: 14 },
                { epistle: '2 Corinthians', epistleChapter: 8, gospel: 'Mark', gospelChapter: 15 },
                { epistle: '2 Corinthians', epistleChapter: 9, gospel: 'Mark', gospelChapter: 16 },
                
                // Day 45-72: 2 Cor 9-13 + Romans 1-16 + Ephesians 1-6 + Philippians 1 + Acts 1-28
                { epistle: '2 Corinthians', epistleChapter: 9, gospel: 'Acts', gospelChapter: 1 },
                { epistle: '2 Corinthians', epistleChapter: 10, gospel: 'Acts', gospelChapter: 2 },
                { epistle: '2 Corinthians', epistleChapter: 11, gospel: 'Acts', gospelChapter: 3 },
                { epistle: '2 Corinthians', epistleChapter: 12, gospel: 'Acts', gospelChapter: 4 },
                { epistle: '2 Corinthians', epistleChapter: 13, gospel: 'Acts', gospelChapter: 5 },
                { epistle: 'Romans', epistleChapter: 1, gospel: 'Acts', gospelChapter: 6 },
                { epistle: 'Romans', epistleChapter: 2, gospel: 'Acts', gospelChapter: 7 },
                { epistle: 'Romans', epistleChapter: 3, gospel: 'Acts', gospelChapter: 8 },
                { epistle: 'Romans', epistleChapter: 4, gospel: 'Acts', gospelChapter: 9 },
                { epistle: 'Romans', epistleChapter: 5, gospel: 'Acts', gospelChapter: 10 },
                { epistle: 'Romans', epistleChapter: 6, gospel: 'Acts', gospelChapter: 11 },
                { epistle: 'Romans', epistleChapter: 7, gospel: 'Acts', gospelChapter: 12 },
                { epistle: 'Romans', epistleChapter: 8, gospel: 'Acts', gospelChapter: 13 },
                { epistle: 'Romans', epistleChapter: 9, gospel: 'Acts', gospelChapter: 14 },
                { epistle: 'Romans', epistleChapter: 10, gospel: 'Acts', gospelChapter: 15 },
                { epistle: 'Romans', epistleChapter: 11, gospel: 'Acts', gospelChapter: 16 },
                { epistle: 'Romans', epistleChapter: 12, gospel: 'Acts', gospelChapter: 17 },
                { epistle: 'Romans', epistleChapter: 13, gospel: 'Acts', gospelChapter: 18 },
                { epistle: 'Romans', epistleChapter: 14, gospel: 'Acts', gospelChapter: 19 },
                { epistle: 'Romans', epistleChapter: 15, gospel: 'Acts', gospelChapter: 20 },
                { epistle: 'Romans', epistleChapter: 16, gospel: 'Acts', gospelChapter: 21 },
                { epistle: 'Ephesians', epistleChapter: 1, gospel: 'Acts', gospelChapter: 22 },
                { epistle: 'Ephesians', epistleChapter: 2, gospel: 'Acts', gospelChapter: 23 },
                { epistle: 'Ephesians', epistleChapter: 3, gospel: 'Acts', gospelChapter: 24 },
                { epistle: 'Ephesians', epistleChapter: 4, gospel: 'Acts', gospelChapter: 25 },
                { epistle: 'Ephesians', epistleChapter: 5, gospel: 'Acts', gospelChapter: 26 },
                { epistle: 'Ephesians', epistleChapter: 6, gospel: 'Acts', gospelChapter: 27 },
                { epistle: 'Philippians', epistleChapter: 1, gospel: 'Acts', gospelChapter: 28 },
                
                // Day 73-94: Philippians 2-4 + Colossians 1-4 + Philemon + 1 Tim 1-6 + Titus 1-3 + 1 Peter 1-5 + Revelation 1-22
                { epistle: 'Philippians', epistleChapter: 2, gospel: 'Revelation', gospelChapter: 1 },
                { epistle: 'Philippians', epistleChapter: 3, gospel: 'Revelation', gospelChapter: 2 },
                { epistle: 'Philippians', epistleChapter: 4, gospel: 'Revelation', gospelChapter: 3 },
                { epistle: 'Colossians', epistleChapter: 1, gospel: 'Revelation', gospelChapter: 4 },
                { epistle: 'Colossians', epistleChapter: 2, gospel: 'Revelation', gospelChapter: 5 },
                { epistle: 'Colossians', epistleChapter: 3, gospel: 'Revelation', gospelChapter: 6 },
                { epistle: 'Colossians', epistleChapter: 4, gospel: 'Revelation', gospelChapter: 7 },
                { epistle: 'Philemon', epistleChapter: 1, gospel: 'Revelation', gospelChapter: 8 },
                { epistle: '1 Timothy', epistleChapter: 1, gospel: 'Revelation', gospelChapter: 9 },
                { epistle: '1 Timothy', epistleChapter: 2, gospel: 'Revelation', gospelChapter: 10 },
                { epistle: '1 Timothy', epistleChapter: 3, gospel: 'Revelation', gospelChapter: 11 },
                { epistle: '1 Timothy', epistleChapter: 4, gospel: 'Revelation', gospelChapter: 12 },
                { epistle: '1 Timothy', epistleChapter: 5, gospel: 'Revelation', gospelChapter: 13 },
                { epistle: '1 Timothy', epistleChapter: 6, gospel: 'Revelation', gospelChapter: 14 },
                { epistle: 'Titus', epistleChapter: 1, gospel: 'Revelation', gospelChapter: 15 },
                { epistle: 'Titus', epistleChapter: 2, gospel: 'Revelation', gospelChapter: 16 },
                { epistle: 'Titus', epistleChapter: 3, gospel: 'Revelation', gospelChapter: 17 },
                { epistle: '1 Peter', epistleChapter: 1, gospel: 'Revelation', gospelChapter: 18 },
                { epistle: '1 Peter', epistleChapter: 2, gospel: 'Revelation', gospelChapter: 19 },
                { epistle: '1 Peter', epistleChapter: 3, gospel: 'Revelation', gospelChapter: 20 },
                { epistle: '1 Peter', epistleChapter: 4, gospel: 'Revelation', gospelChapter: 21 },
                { epistle: '1 Peter', epistleChapter: 5, gospel: 'Revelation', gospelChapter: 22 },
                
                // Day 95-104: 2 Timothy 1-4 + 2 Peter 1-3 + Hebrews 1-13 + Jude + 1-3 John (no more gospel readings)
                { epistle: '2 Timothy', epistleChapter: 1, gospel: null, gospelChapter: null },
                { epistle: '2 Timothy', epistleChapter: 2, gospel: null, gospelChapter: null },
                { epistle: '2 Timothy', epistleChapter: 3, gospel: null, gospelChapter: null },
                { epistle: '2 Timothy', epistleChapter: 4, gospel: null, gospelChapter: null },
                { epistle: '2 Peter', epistleChapter: 1, gospel: null, gospelChapter: null },
                { epistle: '2 Peter', epistleChapter: 2, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 2, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 3, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 4, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 5, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 6, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 7, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 8, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 9, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 10, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 11, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 12, gospel: null, gospelChapter: null },
                { epistle: 'Hebrews', epistleChapter: 13, gospel: null, gospelChapter: null },
                
                // Day 114: Jude
                { epistle: 'Jude', epistleChapter: 1, gospel: null, gospelChapter: null },
                
                // Day 115-119: 1 John 1-5
                { epistle: '1 John', epistleChapter: 1, gospel: null, gospelChapter: null },
                { epistle: '1 John', epistleChapter: 2, gospel: null, gospelChapter: null },
                { epistle: '1 John', epistleChapter: 3, gospel: null, gospelChapter: null },
                { epistle: '1 John', epistleChapter: 4, gospel: null, gospelChapter: null },
                { epistle: '1 John', epistleChapter: 5, gospel: null, gospelChapter: null },
                
                // Day 120-121: 2-3 John
                { epistle: '2 John', epistleChapter: 1, gospel: null, gospelChapter: null },
                { epistle: '3 John', epistleChapter: 1, gospel: null, gospelChapter: null }
            ]
        };

        const workoutPrograms = {
            push: [
                { name: 'Barbell Bench Press', sets: 3, reps: 8, rest: '2-3 min', type: 'compound' },
                { name: 'Overhead Press', sets: 3, reps: 8, rest: '2-3 min', type: 'compound' },
                { name: 'Incline Dumbbell Press', sets: 3, reps: 10, rest: '90 sec', type: 'accessory' },
                { name: 'Dips', sets: 3, reps: 10, rest: '90 sec', type: 'accessory' },
                { name: 'Lateral Raises', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' },
                { name: 'Tricep Pushdowns', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' }
            ],
            pull: [
                { name: 'Pull-ups/Lat Pulldown', sets: 3, reps: 8, rest: '2-3 min', type: 'compound' },
                { name: 'Barbell Row', sets: 3, reps: 8, rest: '2-3 min', type: 'compound' },
                { name: 'Seated Cable Row', sets: 3, reps: 10, rest: '90 sec', type: 'compound' },
                { name: 'Face Pulls', sets: 3, reps: 15, rest: '60 sec', type: 'accessory' },
                { name: 'Barbell Curl', sets: 3, reps: 10, rest: '60 sec', type: 'isolation' },
                { name: 'Hammer Curls', sets: 3, reps: 10, rest: '60 sec', type: 'isolation' }
            ],
            legs: [
                { name: 'Barbell Squat', sets: 3, reps: 8, rest: '3 min', type: 'compound' },
                { name: 'Romanian Deadlift', sets: 3, reps: 8, rest: '2-3 min', type: 'compound' },
                { name: 'Bulgarian Split Squat', sets: 3, reps: 10, rest: '90 sec', type: 'accessory' },
                { name: 'Leg Curls', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' },
                { name: 'Leg Extensions', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' },
                { name: 'Calf Raises', sets: 3, reps: 15, rest: '60 sec', type: 'isolation' }
            ],
            'push-travel': [
                { name: 'Push-ups', sets: 3, reps: 15, rest: '90 sec', type: 'compound' },
                { name: 'Pike Push-ups', sets: 3, reps: 10, rest: '90 sec', type: 'compound' },
                { name: 'Dumbbell Floor Press', sets: 3, reps: 12, rest: '90 sec', type: 'accessory' },
                { name: 'Dumbbell Shoulder Press', sets: 3, reps: 10, rest: '90 sec', type: 'accessory' },
                { name: 'Dumbbell Lateral Raises', sets: 3, reps: 15, rest: '60 sec', type: 'isolation' },
                { name: 'Diamond Push-ups', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' }
            ],
            'pull-travel': [
                { name: 'Pull-ups/Inverted Rows', sets: 3, reps: 10, rest: '2 min', type: 'compound' },
                { name: 'Dumbbell Rows', sets: 3, reps: 12, rest: '90 sec', type: 'compound' },
                { name: 'Dumbbell Pullover', sets: 3, reps: 12, rest: '90 sec', type: 'accessory' },
                { name: 'Reverse Snow Angels', sets: 3, reps: 15, rest: '60 sec', type: 'accessory' },
                { name: 'Dumbbell Curls', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' },
                { name: 'Dumbbell Hammer Curls', sets: 3, reps: 12, rest: '60 sec', type: 'isolation' }
            ],
            'legs-travel': [
                { name: 'Goblet Squat', sets: 3, reps: 15, rest: '2 min', type: 'compound' },
                { name: 'Dumbbell Romanian Deadlift', sets: 3, reps: 12, rest: '2 min', type: 'compound' },
                { name: 'Bulgarian Split Squat', sets: 3, reps: 12, rest: '90 sec', type: 'accessory' },
                { name: 'Walking Lunges', sets: 3, reps: 20, rest: '90 sec', type: 'accessory' },
                { name: 'Single-Leg Romanian Deadlift', sets: 3, reps: 10, rest: '60 sec', type: 'isolation' },
                { name: 'Calf Raises', sets: 3, reps: 20, rest: '60 sec', type: 'isolation' }
            ]
        };

        let currentWorkoutType = null;
        let workoutData = {};
        let currentMode = 'gym';
        let readingData = { mwfIndex: 0, tthIndex: 0, history: [] };

        // Initialize storage
        async function initStorage() {
            try {
                const stored = await window.storage.get('workout-history');
                if (stored) {
                    workoutData = JSON.parse(stored.value);
                }
            } catch (e) {
                workoutData = { history: [], lastWorkout: {} };
            }
            
            try {
                const storedReading = await window.storage.get('reading-history');
                if (storedReading) {
                    readingData = JSON.parse(storedReading.value);
                }
            } catch (e) {
                readingData = { mwfIndex: 0, tthIndex: 0, history: [] };
            }
            
            updateStats();
            renderCalendar();
            updateExerciseSelect();
            updateTodayReading();
            updateReadingProgress();
        }

        // Save data
        async function saveData() {
            try {
                await window.storage.set('workout-history', JSON.stringify(workoutData));
                await window.storage.set('reading-history', JSON.stringify(readingData));
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        // Mode toggle
        document.querySelectorAll('.mode-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-toggle').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                
                // Reset workout selection
                document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('exerciseList').innerHTML = '';
                document.getElementById('completeWorkout').style.display = 'none';
                currentWorkoutType = null;
            });
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.view).classList.add('active');
            });
        });

        // Workout type selection
        document.querySelectorAll('.workout-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Append mode suffix if in travel mode
                const baseType = btn.dataset.type;
                currentWorkoutType = currentMode === 'travel' ? `${baseType}-travel` : baseType;
                
                renderExercises(currentWorkoutType);
            });
        });

        // Render exercises
        function renderExercises(type) {
            const exercises = workoutPrograms[type];
            const list = document.getElementById('exerciseList');
            list.innerHTML = exercises.map((ex, idx) => `
                <div class="exercise-item" id="exercise-${idx}">
                    <div class="exercise-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="checkbox" class="exercise-checkbox" id="check-${idx}" onchange="toggleExercise(${idx})">
                            <div class="exercise-name">${ex.name}</div>
                        </div>
                        <div class="rest-badge">Rest: ${ex.rest}</div>
                    </div>
                    <div class="exercise-inputs">
                        <div class="input-group">
                            <label class="input-label">Sets</label>
                            <input type="number" value="${ex.sets}" data-idx="${idx}" data-field="sets" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Reps</label>
                            <input type="number" value="${ex.reps}" data-idx="${idx}" data-field="reps" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Weight (lbs)</label>
                            <input type="number" value="0" data-idx="${idx}" data-field="weight" min="0" step="5">
                        </div>
                    </div>
                    <div class="suggestion" id="suggestion-${idx}"></div>
                </div>
            `).join('');

            // Load previous data and show suggestions
            const lastWorkout = workoutData.lastWorkout?.[type];
            if (lastWorkout) {
                exercises.forEach((ex, idx) => {
                    const prev = lastWorkout.find(e => e.name === ex.name);
                    if (prev) {
                        const inputs = list.querySelectorAll(`[data-idx="${idx}"]`);
                        inputs.forEach(input => {
                            if (input.dataset.field === 'weight') {
                                input.value = prev.weight;
                            }
                        });
                        
                        // Generate suggestion
                        const suggestion = generateSuggestion(prev, ex);
                        if (suggestion) {
                            const suggDiv = document.getElementById(`suggestion-${idx}`);
                            suggDiv.textContent = suggestion;
                            suggDiv.classList.add('show');
                        }
                    }
                });
            }

            document.getElementById('completeWorkout').style.display = 'block';
        }

        // Toggle exercise completion
        window.toggleExercise = function(idx) {
            const exerciseItem = document.getElementById(`exercise-${idx}`);
            const checkbox = document.getElementById(`check-${idx}`);
            
            if (checkbox.checked) {
                exerciseItem.classList.add('completed');
            } else {
                exerciseItem.classList.remove('completed');
            }
        }

        // Generate progression suggestion
        function generateSuggestion(prev, template) {
            // If they completed all reps with good form, suggest progression
            if (prev.reps >= template.reps && prev.sets >= template.sets) {
                // For compound lifts, add weight
                if (template.type === 'compound') {
                    return `💪 Great work! Try adding 5 lbs (${prev.weight + 5} lbs total)`;
                }
                // For accessories/isolation, add reps first
                if (prev.reps < 15) {
                    return `💪 Nice! Try adding 1-2 more reps per set`;
                } else {
                    return `💪 Strong! Consider adding 2.5-5 lbs`;
                }
            }
            return null;
        }

        // Complete workout
        document.getElementById('completeWorkout').addEventListener('click', () => {
            if (!currentWorkoutType) return;

            const exercises = workoutPrograms[currentWorkoutType];
            const workoutLog = exercises.map((ex, idx) => {
                const inputs = document.querySelectorAll(`[data-idx="${idx}"]`);
                return {
                    name: ex.name,
                    sets: parseInt(inputs[0].value),
                    reps: parseInt(inputs[1].value),
                    weight: parseInt(inputs[2].value),
                    rest: ex.rest
                };
            });

            if (!workoutData.history) workoutData.history = [];
            workoutData.history.push({
                date: new Date().toISOString(),
                type: currentWorkoutType,
                exercises: workoutLog
            });

            if (!workoutData.lastWorkout) workoutData.lastWorkout = {};
            workoutData.lastWorkout[currentWorkoutType] = workoutLog;

            saveData();
            updateStats();
            renderCalendar();
            updateExerciseSelect();

            alert('🔥 Workout logged! Keep crushing it!');
            
            // Reset
            document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('exerciseList').innerHTML = '';
            document.getElementById('completeWorkout').style.display = 'none';
            currentWorkoutType = null;
        });

        // Update today's reading assignment
        function updateTodayReading() {
            console.log('updateTodayReading called');
            const today = new Date().getDay(); // 0=Sun, 1=Mon, 2=Tue, etc.
            const container = document.getElementById('todayReading');
            const btn = document.getElementById('completeReading');
            
            console.log('Container:', container);
            console.log('Button:', btn);
            console.log('bibleReadingPlan exists:', typeof bibleReadingPlan !== 'undefined');
            console.log('readingData:', readingData);
            
            if (!container || !btn) {
                console.error('Reading elements not found');
                return;
            }
            
            if (typeof bibleReadingPlan === 'undefined' || !bibleReadingPlan.mwf || !bibleReadingPlan.tth) {
                console.error('Reading plan not loaded:', bibleReadingPlan);
                container.innerHTML = '<div class="no-data">Reading plan not loaded - check console</div>';
                return;
            }
            
            let assignment = '';
            let canComplete = false;
            
            // Check if already completed today
            const todayStr = new Date().toDateString();
            const completedToday = readingData.history.some(r => new Date(r.date).toDateString() === todayStr);
            
            if (completedToday) {
                container.innerHTML = '<div style="color: var(--success); font-weight: 600;">✓ Today\'s reading completed!</div>';
                btn.style.display = 'none';
                return;
            }
            
            if (today === 1 || today === 3 || today === 5) { // Mon/Wed/Fri
                const reading = bibleReadingPlan.mwf[readingData.mwfIndex];
                console.log('Mon/Wed/Fri reading:', reading);
                if (reading) {
                    assignment = `<strong>Old Testament:</strong><br>${reading.book} ${reading.chapters.join(', ')}`;
                    canComplete = true;
                } else {
                    assignment = '<div style="color: var(--success);">🎉 Old Testament complete!</div>';
                }
            } else if (today === 2 || today === 4) { // Tue/Thu
                const reading = bibleReadingPlan.tth[readingData.tthIndex];
                console.log('Tue/Thu reading:', reading);
                if (reading) {
                    assignment = '<strong>New Testament:</strong><br>';
                    
                    // Epistle
                    if (reading.epistle) {
                        assignment += `${reading.epistle} ${reading.epistleChapter}`;
                    }
                    
                    // Gospel/Acts/Revelation
                    if (reading.gospel) {
                        if (reading.epistle) assignment += '<br>';
                        assignment += `${reading.gospel} ${reading.gospelChapter}`;
                    }
                    
                    canComplete = true;
                } else {
                    assignment = '<div style="color: var(--success);">🎉 New Testament complete!</div>';
                }
            } else { // Weekend
                assignment = '<div style="color: var(--text-dim);">Rest day - No reading scheduled for weekends</div>';
            }
            
            console.log('Final assignment:', assignment);
            container.innerHTML = assignment || '<div class="no-data">Reading plan complete!</div>';
            btn.style.display = canComplete ? 'block' : 'none';
        }

        // Complete reading
        document.getElementById('completeReading').addEventListener('click', () => {
            const today = new Date().getDay();
            let stream = '';
            let historyEntry = {
                date: new Date().toISOString()
            };
            
            if (today === 1 || today === 3 || today === 5) {
                stream = 'mwf';
                historyEntry.stream = stream;
                historyEntry.mwfIndex = readingData.mwfIndex;
                readingData.mwfIndex++;
            } else if (today === 2 || today === 4) {
                stream = 'tth';
                historyEntry.stream = stream;
                historyEntry.tthIndex = readingData.tthIndex;
                readingData.tthIndex++;
            }
            
            readingData.history.push(historyEntry);
            
            saveData();
            updateTodayReading();
            updateReadingProgress();
            updateStats();
            renderCalendar();
            
            alert('📖 Reading complete! Keep growing in the Word!');
        });

        // Next reading (skip ahead without marking today complete)

        // Update reading progress bars
        function updateReadingProgress() {
            const mwfTotal = bibleReadingPlan.mwf.length;
            const tthTotal = bibleReadingPlan.tth.length;
            
            // Old Testament (MWF)
            const mwfPercent = Math.round((readingData.mwfIndex / mwfTotal) * 100);
            document.getElementById('mwfProgress').textContent = `${mwfPercent}%`;
            document.getElementById('mwfBar').style.width = `${mwfPercent}%`;
            
            const mwfCurrent = bibleReadingPlan.mwf[readingData.mwfIndex];
            document.getElementById('mwfCurrent').textContent = mwfCurrent 
                ? `Currently reading: ${mwfCurrent.book}` 
                : 'Old Testament complete!';
            
            // New Testament (TTH) - Combined progress for both epistle and gospel streams
            const tthPercent = Math.round((readingData.tthIndex / tthTotal) * 100);
            document.getElementById('tthProgress').textContent = `${tthPercent}%`;
            document.getElementById('tthBar').style.width = `${tthPercent}%`;
            
            const tthCurrent = bibleReadingPlan.tth[readingData.tthIndex];
            
            // Show current books in NT
            if (tthCurrent) {
                let currentBooks = [];
                if (tthCurrent.epistle) currentBooks.push(tthCurrent.epistle);
                if (tthCurrent.gospel) currentBooks.push(tthCurrent.gospel);
                
                if (currentBooks.length > 0) {
                    document.getElementById('tthCurrent').textContent = `Currently reading: ${currentBooks.join(' & ')}`;
                } else {
                    document.getElementById('tthCurrent').textContent = 'New Testament complete!';
                }
            } else {
                document.getElementById('tthCurrent').textContent = 'New Testament complete!';
            }
                
            // Overall Bible progress (all streams combined)
            const totalChapters = mwfTotal * 6.5 + 87 + 78; // OT + Epistles + Gospel/Acts/Rev
            const completedChapters = (readingData.mwfIndex * 6.5) + (readingData.tthIndex * 1.6);
            const overallPercent = Math.round((completedChapters / totalChapters) * 100);
            document.getElementById('bibleProgress').textContent = `${overallPercent}%`;
        }

        // Update stats
        function updateStats() {
            if (!workoutData.history) {
                workoutData.history = [];
            }
            if (!readingData.history) {
                readingData.history = [];
            }

            // This week's workouts
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const thisWeekWorkouts = workoutData.history.filter(w => new Date(w.date) >= weekStart);
            document.getElementById('weekWorkouts').textContent = `${thisWeekWorkouts.length}/3`;

            // This week's readings
            const thisWeekReadings = readingData.history.filter(r => new Date(r.date) >= weekStart);
            document.getElementById('weekReadings').textContent = `${thisWeekReadings.length}/5`;

            // Total workouts
            document.getElementById('totalWorkouts').textContent = workoutData.history.length;
        }

        function calculateWorkoutWeeks() {
            if (!workoutData.history || workoutData.history.length === 0) return 0;

            const weeklyWorkouts = {};
            
            workoutData.history.forEach(w => {
                const date = new Date(w.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                weekStart.setHours(0, 0, 0, 0);
                const weekKey = weekStart.toISOString();
                
                if (!weeklyWorkouts[weekKey]) {
                    weeklyWorkouts[weekKey] = new Set();
                }
                weeklyWorkouts[weekKey].add(new Date(w.date).toDateString());
            });

            let workoutWeeks = 0;
            Object.values(weeklyWorkouts).forEach(days => {
                if (days.size >= 3) {
                    workoutWeeks++;
                }
            });

            return workoutWeeks;
        }

        function calculateReadingWeeks() {
            if (!readingData.history || readingData.history.length === 0) return 0;

            const weeklyReadings = {};
            
            readingData.history.forEach(r => {
                const date = new Date(r.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                weekStart.setHours(0, 0, 0, 0);
                const weekKey = weekStart.toISOString();
                
                if (!weeklyReadings[weekKey]) {
                    weeklyReadings[weekKey] = new Set();
                }
                weeklyReadings[weekKey].add(new Date(r.date).toDateString());
            });

            let readingWeeks = 0;
            Object.values(weeklyReadings).forEach(days => {
                if (days.size >= 5) {
                    readingWeeks++;
                }
            });

            return readingWeeks;
        }

        // Render calendar (weekly view)
        // Bible book abbreviations
        const bibleAbbreviations = {
            'Genesis': 'Gen', 'Exodus': 'Exod', 'Leviticus': 'Lev', 'Numbers': 'Num', 'Deuteronomy': 'Deut',
            'Joshua': 'Josh', 'Judges': 'Judg', 'Ruth': 'Ruth', '1 Samuel': '1 Sam', '2 Samuel': '2 Sam',
            '1 Kings': '1 Kgs', '2 Kings': '2 Kgs', '1 Chronicles': '1 Chr', '2 Chronicles': '2 Chr',
            'Ezra': 'Ezra', 'Nehemiah': 'Neh', 'Esther': 'Esth', 'Job': 'Job', 'Psalms': 'Ps',
            'Proverbs': 'Prov', 'Ecclesiastes': 'Eccl', 'Song of Solomon': 'Song', 'Isaiah': 'Isa',
            'Jeremiah': 'Jer', 'Lamentations': 'Lam', 'Ezekiel': 'Ezek', 'Daniel': 'Dan', 'Hosea': 'Hos',
            'Joel': 'Joel', 'Amos': 'Amos', 'Obadiah': 'Obad', 'Jonah': 'Jonah', 'Micah': 'Mic',
            'Nahum': 'Nah', 'Habakkuk': 'Hab', 'Zephaniah': 'Zeph', 'Haggai': 'Hag', 'Zechariah': 'Zech',
            'Malachi': 'Mal', 'Matthew': 'Matt', 'Mark': 'Mark', 'Luke': 'Luke', 'John': 'John',
            'Acts': 'Acts', 'Romans': 'Rom', '1 Corinthians': '1 Cor', '2 Corinthians': '2 Cor',
            'Galatians': 'Gal', 'Ephesians': 'Eph', 'Philippians': 'Phil', 'Colossians': 'Col',
            '1 Thessalonians': '1 Thess', '2 Thessalonians': '2 Thess', '1 Timothy': '1 Tim',
            '2 Timothy': '2 Tim', 'Titus': 'Titus', 'Philemon': 'Phlm', 'Hebrews': 'Heb',
            'James': 'Jas', '1 Peter': '1 Pet', '2 Peter': '2 Pet', '1 John': '1 John',
            '2 John': '2 John', '3 John': '3 John', 'Jude': 'Jude', 'Revelation': 'Rev'
        };

        function renderCalendar() {
            const cal = document.getElementById('calendarView');
            const now = new Date();
            
            // Get the start of the current week (Sunday)
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);

            const workoutHistory = workoutData.history || [];
            const readingHistory = readingData.history || [];

            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            let html = '';

            // Generate 7 days for the current week
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toDateString();
                const dayNum = date.getDate();
                const isToday = dateStr === now.toDateString();
                
                // Find workout for this day
                const workout = workoutHistory.find(w => new Date(w.date).toDateString() === dateStr);
                
                // Find reading for this day
                const reading = readingHistory.find(r => new Date(r.date).toDateString() === dateStr);
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                
                let pillsHtml = '';
                
                // Workout pill
                if (workout) {
                    const workoutLabel = workout.type === 'push' ? 'Push' 
                        : workout.type === 'pull' ? 'Pull' 
                        : 'Legs';
                    
                    pillsHtml += `
                        <div class="activity-pill workout-pill" title="${workoutLabel} workout">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.57 14.86L22 13.43L20.57 12L17 15.57L8.43 7L12 3.43L10.57 2L9.14 3.43L7.71 2L5.57 4.14L4.14 2.71L2.71 4.14L4.14 5.57L2 7.71L3.43 9.14L2 10.57L3.43 12L7 8.43L15.57 17L12 20.57L13.43 22L14.86 20.57L16.29 22L18.43 19.86L19.86 21.29L21.29 19.86L19.86 18.43L22 16.29L20.57 14.86Z" />
                            </svg>
                            <span>${workoutLabel}</span>
                        </div>
                    `;
                }
                
                // Reading pill
                if (reading) {
                    let readingText = '';
                    const dayOfWeek = date.getDay();
                    
                    if (dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 5) { // Mon/Wed/Fri
                        const idx = reading.mwfIndex !== undefined ? reading.mwfIndex : readingData.mwfIndex;
                        const assignment = bibleReadingPlan.mwf[idx];
                        if (assignment) {
                            const abbrev = bibleAbbreviations[assignment.book] || assignment.book;
                            readingText = `${abbrev} ${assignment.chapters.join(',')}`;
                        }
                    } else if (dayOfWeek === 2 || dayOfWeek === 4) { // Tue/Thu
                        const idx = reading.tthIndex !== undefined ? reading.tthIndex : readingData.tthIndex;
                        const assignment = bibleReadingPlan.tth[idx];
                        if (assignment) {
                            const parts = [];
                            if (assignment.epistle) {
                                const abbrev = bibleAbbreviations[assignment.epistle] || assignment.epistle;
                                parts.push(`${abbrev} ${assignment.epistleChapter}`);
                            }
                            if (assignment.gospel) {
                                const abbrev = bibleAbbreviations[assignment.gospel] || assignment.gospel;
                                parts.push(`${abbrev} ${assignment.gospelChapter}`);
                            }
                            readingText = parts.join(' & ');
                        }
                    }
                    
                    if (readingText) {
                        pillsHtml += `
                            <div class="activity-pill reading-pill" title="${readingText}">
                                <svg width="14" height="14" viewBox="0 -960 960 960" fill="currentColor">
                                    <path d="M440-278v-394q-41-24-87-36t-93-12q-36 0-71.5 7T120-692v396q35-12 69.5-18t70.5-6q47 0 91.5 10.5T440-278Zm40 118q-48-38-104-59t-116-21q-42 0-82.5 11T100-198q-21 11-40.5-1T40-234v-482q0-11 5.5-21T62-752q46-24 96-36t102-12q74 0 126 17t112 52q11 6 16.5 14t5.5 21v418q44-21 88.5-31.5T700-320q36 0 70.5 6t69.5 18v-481q15 5 29.5 11t28.5 14q11 5 16.5 15t5.5 21v482q0 23-19.5 35t-40.5 1q-37-20-77.5-31T700-240q-60 0-116 21t-104 59Zm140-240v-440l120-40v440l-120 40Zm-340-99Z"/>
                                </svg>
                                <span>${readingText}</span>
                            </div>
                        `;
                    }
                }
                
                html += `
                    <div class="${classes}">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="display: flex; flex-direction: column;">
                                <div class="day-name">${days[i]}</div>
                                <div class="day-number">${dayNum}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end;">
                                ${pillsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }

            cal.innerHTML = html;
        }

        // Update exercise select
        function updateExerciseSelect() {
            const select = document.getElementById('exerciseSelect');
            const allExercises = new Set();
            
            (workoutData.history || []).forEach(workout => {
                workout.exercises.forEach(ex => allExercises.add(ex.name));
            });

            select.innerHTML = '<option>Select an exercise to view progress</option>' +
                Array.from(allExercises).map(name => `<option value="${name}">${name}</option>`).join('');

            select.addEventListener('change', (e) => {
                if (e.target.value !== 'Select an exercise to view progress') {
                    renderProgressChart(e.target.value);
                }
            });
        }

        // Render progress chart
        function renderProgressChart(exerciseName) {
            const chart = document.getElementById('progressChart');
            const data = (workoutData.history || [])
                .filter(w => w.exercises.some(ex => ex.name === exerciseName))
                .map(w => ({
                    date: new Date(w.date).toLocaleDateString(),
                    ...w.exercises.find(ex => ex.name === exerciseName)
                }));

            if (data.length === 0) {
                chart.innerHTML = '<div class="no-data">No data for this exercise yet</div>';
                return;
            }

            const maxWeight = Math.max(...data.map(d => d.weight));
            const maxReps = Math.max(...data.map(d => d.reps));

            chart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${data.map((d, i) => `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="min-width: 100px; color: var(--text-dim); font-size: 0.85rem;">${d.date}</div>
                            <div style="flex: 1; background: var(--darker); border-radius: 4px; height: 40px; position: relative; overflow: hidden;">
                                <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${(d.weight / maxWeight) * 100}%; background: linear-gradient(90deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: flex-end; padding-right: 1rem; font-weight: 700; transition: width 0.5s ease-out; animation-delay: ${i * 0.1}s;">
                                    ${d.weight} lbs × ${d.reps}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Initialize
        async function init() {
            await initStorage();
            renderCalendar();
        }
        
        init();
    
        // ---- PWA: Service Worker registration ----
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./service-worker.js").catch(console.error);
            });
        }
</script>
</body>
</html>